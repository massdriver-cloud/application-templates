schema: draft-07
name: <md .Name md>
description: <md .Description md>
source_url: github.com/YOUR_ORG/<md .Name md>
access: private
type: application

app:
  envs:
    # Use jq expressions to build environment variables from input params or connections
    LOG_LEVEL: .params.log_level
    # MONGO_DSN: .connections.mongo_authentication.data.authentication.username + ":" + .connections.mongo_authentication.data.authentication.password + "@" + .connections.mongo_authentication.data.authentication.hostname + ":" + (.connections.mongo_authentication.data.authentication.port|tostring)
  policies: []
    # Use jq expressions to select policies from artifact security blocks
    # - .connections.sqs.data.security.iam.subscribe

params:
  examples:
    - __name: "API"
      endpoint:
        enabled: true
        subdomain: api
  required:
    - container
    - max_instances
    - dns
  properties:
    log_level:
      type: string
      title: Log Level
      description: "The log level to log at. This is an example value, this could be anything!"
      enum:
        - error
        - warning
        - info
    container:
      type: object
      title: Container
      required:
      - repository
      - image
      - tag
      properties:
        repository:
          type: string
          title: Repository
          # You'll generally want to hard code your container repository in your bundle code,
          # but it can be helpful to show it in your schema as well.
          description: Container repository to use for this application.
        image:
          type: string
          title: Image
        tag:
          title: Image Tag
          $ref: https://raw.githubusercontent.com/massdriver-cloud/artifact-definitions/main/definitions/types/docker-image-tag.json
          default: latest
    max_instances:
      type: integer
      title: Max Instances
      description: The maximum number of instances to run at once.
      default: 5
    machine_type:
      type: string
      title: Machine Type
    dns:
      title: DNS
      description: DNS configuration
      type: object
      required:
        - enable_dns
      properties:
        enable_dns:
          title: Enable DNS
          description: Enable DNS configuration for the application.
          type: boolean
          default: false
      dependencies:
        enable_dns:
          oneOf:
            - properties:
                enable_dns:
                  const: true
                zone_id:
                  title: DNS Zone name
                  description: Azure DNS zone name
                  type: string
                subdomain:
                  title: Subdomain
                  description: "Subdomain for DNS zone. Examples: 'www', 'api', 'app'"
                  type: string
                  pattern: ^[-a-zA-Z0-9*._-]{1,63}$
                  message:
                    pattern: Must be a valid subdomain. Must contain only letters, numbers, dashes, underscores, periods, and asterisks.
              required:
                - zone_id
                - subdomain
            - properties:
                enable_dns:
                  const: false

connections:
  required:
    - azure_service_principal
    - azure_virtual_network
  <md- range $key, $art:= .Connections md>
    - <md $key md>
  <md- end md>
  properties:
    azure_service_principal:
      $ref: massdriver/azure-service-principal
    azure_virtual_network:
      $ref: massdriver/azure-virtual-network
  <md- range $key, $art:= .Connections md>
    <md $key md>:
      $ref: <md $art md>
  <md- end md>

ui:
  ui:order:
    - location
    - container
    - max_instances
    - dns
    - "*"
