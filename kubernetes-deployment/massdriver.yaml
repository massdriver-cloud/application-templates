schema: draft-07
name: <md .Name md>
description: <md .Description md>
ref: github.com/YOUR_ORG/<md .Name md>
access: private
type: application

app:
  envs:
    # Use jq expressions to build environment variables from input params or connections
    LOG_LEVEL: .params.log_level
    # MONGO_DSN: .connections.mongo_authentication.data.authentication.username + ":" + .connections.mongo_authentication.data.authentication.password + "@" + .connections.mongo_authentication.data.authentication.hostname + ":" + (.connections.mongo_authentication.data.authentication.port|tostring)
  policies: []
    # Use jq expressions to select policies from artifact security blocks
    # - .connections.sqs.data.security.iam.subscribe

params:
  properties:
    namespace:
      title: Kubernetes Namespace
      type: string
      default: default
    image:
      title: Container Image
      type: object
      properties:
        repository:
          title: Repository
          description: "Container image repository to use for this application. See: https://app.massdriver.cloud/container-repositories"
          type: string
        tag:
          title: Tag
          description:
          type: string
          minLength: 1
    resourceRequests:
      type: object
      properties:
        cpu:
          title: CPU
          description: The minimum CPU resources required for this application.
          type: string
          # TODO: use custom rjsf widget here
        memory:
          title: Memory
          description: The minimum Memory resources required for this application.
          type: string
          # TODO: use custom rjsf widget here
    port:
      title: Port
      description: The container port the application will listen on.
      type: integer
    autoscaling:
      title: Horizonal Autoscaling
      type: object
      properties:
        enabled:
          type: boolean
          default: false
        minReplicas:
          type: integer
          default: 1
        maxReplicas:
          type: integer
          default: 2
        targetCPUUtilizationPercentage:
          type: integer
          default: 90
    ingress:
      title: Ingress
      description: Configure the application for public
      type: object
      properties:
        enabled:
          title: Enable Public Internet Access
          type: boolean
        host:
          title: Hostname
          description: TBD, is this the right field name?
          type: string
        path:
          type: string
          default: '/'

# TODO: if this fails during template rendering because .Conditions isn't present, we shouldn't propogate nils, it should return an empty map
connections:
  required:
    - kubernetes_cluster
  <md- range $key, $art:= .Connections md>
    - <md $key md>
  <md- end md>
  oneOf:
    - required: ["aws_authentication"]
    - required: ["gcp_authentication"]
    - required: ["azure_authentication"]
  properties:
    kubernetes_cluster:
      $ref: massdriver/kubernetes-cluster
    aws_authentication:
      $ref: massdriver/aws-iam-role
    gcp_authentication:
      $ref: massdriver/gcp-service-account
    azure_authentication:
      $ref: massdriver/azure-service-principal
  <md- range $key, $art:= .Connections md>
    <md $key md>:
      $ref: <md $art md>
  <md- end md>

artifacts:
  properties:
    debug:
      $ref: massdriver/env-file
ui:
  image:
    repository:
      # Custom field docs: https://github.com/massdriver-cloud/docs/issues/8
      ui:field: "containerRepositoriesDropdown"
      # TODO: we need to make a cloud agnositc query var "any" or default to "any" if `cloud` is omitted
      cloud: "aws"
  ui:order:
    - namespace
    - image
    - resource_requests
    - autoscaling
    - port
    - ingress
  autoscaling:
    items:
      ui:order:
        - enabled
        - minReplicas
        - maxReplicas
        - targetCPUUtilizationPercentage
  ingress:
    items:
      ui:order:
        - enabled
        - host
        - path
