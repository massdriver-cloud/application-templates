schema: draft-07
name: <md .Name md>
description: <md .Description md>
ref: github.com/YOUR_ORG/<md .Name md>
access: private
type: application

app:
  envs:
    # Use jq expressions to build environment variables from input params or connections
    LOG_LEVEL: .params.log_level
    # MONGO_DSN: .connections.mongo_authentication.data.authentication.username + ":" + .connections.mongo_authentication.data.authentication.password + "@" + .connections.mongo_authentication.data.authentication.hostname + ":" + (.connections.mongo_authentication.data.authentication.port|tostring)
  policies: []
    # Use jq expressions to select policies from artifact security blocks
    # - .connections.sqs.data.security.iam.subscribe

params:
  examples:
    - __name: "API"
      endpoint:
        enabled: true
        subdomain: api
  required:
    - location
    - private_service_cidr
    - container
  properties:
    location:
      title: Region
      $ref: https://raw.githubusercontent.com/massdriver-cloud/artifact-definitions/main/definitions/types/gcp-region.json
      $md.immutable: true
    private_service_cidr:
      $ref: https://raw.githubusercontent.com/massdriver-cloud/artifact-definitions/main/definitions/types/cidr.json
      title: Private Service CIDR
      description: The CIDR range Cloud Run will use to access things in your VPC like databases and caches.
      default: "10.100.0.0/28"
    log_level:
      type: string
      title: Log Level
      description: "The log level to log at. This is an example value, this could be anything!"
      enum:
        - error
        - warning
        - info
    container:
      type: object
      title: Container
      required:
      - repository
      - image
      - tag
      properties:
        repository:
          type: string
          title: Repository
          # Container repositories can be created or imported into massdriver at: https://app.massdriver.cloud/container-repositories
          # You'll generally want to hard code your container repository in your bundle code, but it can be helpful to show it
          # in your schema as well.
          # If you need to allow an end-user developer to select the container repo, you can use our drop down widget documented here: https://docs.massdriver.cloud/bundles/custom-widgets-and-fields
          description: Container repository to use for this application.
        image:
          type: string
          title: Image
        tag:
          title: Image Tag
          $ref: https://raw.githubusercontent.com/massdriver-cloud/artifact-definitions/main/definitions/types/docker-image-tag.json
          default: latest
    endpoint:
      type: object
      title: Endpoint
      description: Configure a public endpoint with DNS and a SSL certificate.
      required:
        - enabled
      properties:
        enabled:
          type: boolean
          title: Enabled
          default: false
      dependencies:
        enabled:
          oneOf:
            - required:
                - zone
                - subdomain
              properties:
                enabled:
                  const: true
                  title: Enabled
                zone:
                  $ref: https://raw.githubusercontent.com/massdriver-cloud/artifact-definitions/main/definitions/types/gcp-cloud-dns-managed-zone.json
                  title: DNS Zone
                subdomain:
                  type: string
                  title: Subdomain
                  description: The subdomain will be prefixed to the DNS zone, creating a public endpoint for your application.
            - properties:
                enabled:
                  const: false
                  title: Enabled

connections:
  required:
    - gcp_authentication
    # The global network is required so we can create a private service connection.
    # This allows your application to access things in your VPC like databases and caches.
    - gcp_global_network
  <md- range $key, $art:= .Connections md>
    - <md $key md>
  <md- end md>
  properties:
    gcp_authentication:
      $ref: massdriver/gcp-service-account
    gcp_global_network:
      $ref: massdriver/gcp-global-network
  <md- range $key, $art:= .Connections md>
    <md $key md>:
      $ref: <md $art md>
  <md- end md>

ui:
  ## If you need to allow an end user to select the container repository at deploy time, our smart widget can be used.
  ## Additional documentation here: https://docs.massdriver.cloud/bundles/custom-widgets-and-fields
  # image:
  #   repository:
  #     ui:field: "containerRepositoriesDropdown"
  #     cloud: "gcp"
  ui:order:
    - location
    - container
    - endpoint
    - "*"
  location:
    ui:field: regionsDropdown
    cloud: gcp
  container:
    ui:order:
      - repository
      - image
      - tag
    repository:
      ui:field: containerRepositoriesDropdown
      cloud: gcp
  endpoint:
    ui:order:
      - enabled
      - zone
      - subdomain
    zone:
      name:
        ui:field: dnsZonesDropdown
        cloud: gcp

